## TLS / mTLS

- –°–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç mTLS
- –ö–ª–∏–µ–Ω—Ç –æ–±—è–∑–∞–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ TLS (uvicorn)

–§–∞–π–ª—ã:
- ca.crt ‚Äî –∫–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–≤–µ—Ä–∏—è
- server_storage.crt ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞
- server_storage.key ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–ù–ï –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
















# mTLS MANUAL –î–õ–Ø STORAGE SERVICE

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª mTLS (mutual TLS) –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: 
—Ä–æ–ª–∏, —Ñ–∞–π–ª—ã, –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤—ã–ø—É—Å–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.


## 1. –¢–µ—Ä–º–∏–Ω—ã –∏ —Ä–æ–ª–∏

### CA (Certificate Authority)

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**.

* –•—Ä–∞–Ω–∏—Ç **–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á CA** (`ca.key`)
* –í—ã–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤(—Å–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è) –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤(–º–∞–≥–∞–∑–∏–Ω). 
–ü—É—Ç—ë–º –ø–æ–¥–ø–∏—Å–∏ –≤—ã–ø—É—â–µ–Ω–Ω–æ–≥–æ –æ—Ç server_storage.key –∏–ª–∏ server_shop.key .crt

### Storage Service (–°–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è)

–°–µ—Ä–≤–∏—Å —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

* –ò–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ (server_storage.crt)
* **–û–±—è–∑–∞–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (server_shop.crt)**
* –î–æ–≤–µ—Ä—è–µ—Ç **—Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–º—É CA (ca.crt)**

### Client Service (–ú–∞–≥–∞–∑–∏–Ω)

–ö–ª–∏–µ–Ω—Ç, –æ–±—Ä–∞—â–∞—é—â–∏–π—Å—è –∫ storage.

* –ò–º–µ–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (server_shop.crt)
* –ü—Ä–µ–¥—ä—è–≤–ª—è–µ—Ç –µ–≥–æ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–∏ TLS-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–∏

---

## 2. –ú–æ–¥–µ–ª—å –¥–æ–≤–µ—Ä–∏—è (–≤–∞–∂–Ω–æ)

* **CA –¥–æ–≤–µ—Ä—è–µ—Ç –Ω–∏–∫–æ–º—É** ‚Äî –æ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç
* **Storage –¥–æ–≤–µ—Ä—è–µ—Ç CA**
* **Storage –ù–ï –¥–æ–≤–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞–ø—Ä—è–º—É—é**
* **Client –¥–æ–≤–µ—Ä—è–µ—Ç CA**, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

> –ï—Å–ª–∏ CA.key —É–∫—Ä–∞–¥–µ–Ω ‚Äî —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤—Å—è —Å–∏—Å—Ç–µ–º–∞

---

## 5. –í—ã–ø—É—Å–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (OpenSSL)

–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–µ–¥—ã**.

### 5.1 –°–æ–∑–¥–∞–Ω–∏–µ CA

```bash
openssl genrsa -out ca.key 4096

openssl req -x509 -new -nodes \
  -key ca.key \
  -sha256 -days 3650 \
  -out ca.crt \
  -subj "/CN=Storage Internal CA"
```

---

### 5.2 –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ (Storage)
```bash
openssl genrsa -out server_storage.key 2048

openssl req -new \
  -key server_storage.key \
  -out server_storage.csr \
  -subj "/CN=storage.internal"

# –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
openssl x509 -req \
  -in server_storage.csr \
  -CA ca.crt \
  -CAkey ca.key \
  -CAcreateserial \
  -out server_storage.crt \
  -days 825 -sha256
```

> CN –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É

---

### 5.3 –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–ª–∏–µ–Ω—Ç–∞ (Shop)

```bash
openssl genrsa -out client_shop.key 2048

openssl req -new \
  -key client_shop.key \
  -out client_shop.csr \
  -subj "/CN=shop-service"

# –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
openssl x509 -req \
  -in client_shop.csr \
  -CA ca.crt \
  -CAkey ca.key \
  -CAcreateserial \
  -out client_shop.crt \
  -days 825 -sha256
```

---

## 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Storage (Uvicorn)

```python
import ssl

uvicorn.run(
    "main:app",
    host="0.0.0.0",
    port=7591,
    ssl_certfile="certs/storage/server_storage.crt",
    ssl_keyfile="certs/storage/server_storage.key",
    ssl_ca_certs="certs/ca/ca.crt",
    ssl_cert_reqs=ssl.CERT_REQUIRED,
)
```

---

## 7. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (requests)

```python
requests.get(
    "https://storage.internal/health",
    cert=("client_shop.crt", "client_shop.key"),
    verify="ca.crt",
)
```

---

## –†–µ–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, –Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)

1. **–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è**
2. **–°–µ—Ä–≤–µ—Ä —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–π `server.crt`**
3. –ö–ª–∏–µ–Ω—Ç:

   * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ `CA.crt`
   * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç CN / SAN / —Å—Ä–æ–∫
4. **–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ç—Ä–µ–±—É–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (mTLS)**:

   * —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –µ–≥–æ
5. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:

   * `client.crt`
   * **–∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤–ª–∞–¥–µ–Ω–∏—è `client.key`**
6. –°–µ—Ä–≤–µ—Ä:

   * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `client.crt` —á–µ—Ä–µ–∑ `CA.crt`
   * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ä–µ–∞–ª—å–Ω–æ –≤–ª–∞–¥–µ–µ—Ç `client.key`
7. **–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ**

üìå `.key` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è**, —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ handshake-–¥–∞–Ω–Ω—ã—Ö.

---

## 9. –ß—Ç–æ –≤–∞–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞

* TLS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è **–¥–æ FastAPI**
* –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –±–µ–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ ‚Äî —Å–µ—Ä–≤–µ—Ä –¥–∞–∂–µ –Ω–µ –ø—Ä–∏–º–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
* `.pem`, `.crt`, `.key` ‚Äî —ç—Ç–æ —Ñ–æ—Ä–º–∞—Ç—ã, –∞ –Ω–µ —Ä–∞–∑–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
* CA.key —Ö—Ä–∞–Ω–∏—Ç—Å—è **–≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**








1. **CA.key** ‚Äî —ç—Ç–æ **–∑–∞–∫—Ä—ã—Ç—ã–π –∫–ª—é—á —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**. 
–û–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (`.crt`), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è –∏—Ö –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å. 
–í –æ–±—ã—á–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –æ–Ω ¬´–≤—ã–¥–∞—ë—Ç¬ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –ø–æ–¥–ø–∏—Å—ã–≤–∞—è –∏—Ö. 
–û–Ω –Ω–µ ¬´—Å–æ–∑–¥–∞—ë—Ç¬ª –∫–ª—é—á–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî —ç—Ç–∏ –∫–ª—é—á–∏ (`.key`) –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–∞–º–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–º.

2. **Server.key / Client.key** ‚Äî —ç—Ç–æ **–∑–∞–∫—Ä—ã—Ç—ã–µ –∫–ª—é—á–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞**. 
–û–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–æ–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `.crt`. 
–≠—Ç–∏ –∫–ª—é—á–∏ **–Ω–∏–∫–æ–º—É –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**.

3. **Server.crt / Client.crt** ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ CA. 
–ò—Ö **–º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ–º**, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ –∫–ª—é—á–∞ –æ–Ω–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –∞—Ç–∞–∫–∏. 
–ò–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –Ω–∏—Ö —Å–µ—Ä–≤–µ—Ä –∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ (mTLS)** ‚Äî –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–∞–∫:

   * –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–π `.crt` —Å–µ—Ä–≤–µ—Ä—É.
   * –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –Ω–∞ —ç—Ç–æ–º `.crt` —á–µ—Ä–µ–∑ `CA.crt`.
   * –ï—Å–ª–∏ –≤—Å—ë –æ–∫, —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–π `.crt` –∫–ª–∏–µ–Ω—Ç—É.
   * –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º `.crt` —á–µ—Ä–µ–∑ `CA.crt`.
   * –ï—Å–ª–∏ –æ–±–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω—ã ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

–¢–æ –µ—Å—Ç—å –∫–ª—é—á–∏ **–Ω–∏–∫–æ–º—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è**, —Ç–æ–ª—å–∫–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–ø—É–±–ª–∏—á–Ω—ã–µ). CA.key –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ **–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –¥–æ—Å—Ç—É–ø–µ**.


